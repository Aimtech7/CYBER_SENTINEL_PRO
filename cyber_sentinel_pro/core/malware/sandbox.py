import os
import re
import hashlib
from typing import Dict, List

try:
    import pefile
except Exception:
    pefile = None


def file_hashes(path: str) -> Dict[str, str]:
    h_md5 = hashlib.md5()
    h_sha1 = hashlib.sha1()
    h_sha256 = hashlib.sha256()
    with open(path, 'rb') as fh:
        while True:
            b = fh.read(8192)
            if not b:
                break
            h_md5.update(b); h_sha1.update(b); h_sha256.update(b)
    return {
        'md5': h_md5.hexdigest(),
        'sha1': h_sha1.hexdigest(),
        'sha256': h_sha256.hexdigest(),
    }


def extract_strings(path: str, min_len: int = 5) -> List[str]:
    out = []
    with open(path, 'rb') as fh:
        data = fh.read()
    s = ''
    for b in data:
        c = chr(b)
        if c.isprintable():
            s += c
        else:
            if len(s) >= min_len:
                out.append(s)
            s = ''
    if len(s) >= min_len:
        out.append(s)
    return out


def pe_metadata(path: str) -> Dict:
    if not pefile:
        return {}
    try:
        pe = pefile.PE(path)
        return {
            'entry_point': hex(pe.OPTIONAL_HEADER.AddressOfEntryPoint),
            'image_base': hex(pe.OPTIONAL_HEADER.ImageBase),
            'sections': [(s.Name.decode(errors='ignore').strip('\x00'), hex(s.VirtualAddress), s.SizeOfRawData) for s in pe.sections],
        }
    except Exception:
        return {}


IOC_REGEX = {
    'url': re.compile(r'https?://[\w\.-/]+'),
    'ip': re.compile(r'\b(?:\d{1,3}\.){3}\d{1,3}\b'),
    'domain': re.compile(r'\b[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b'),
}


def extract_iocs(strings: List[str]) -> Dict[str, List[str]]:
    iocs = {'url': [], 'ip': [], 'domain': []}
    for s in strings:
        for k, rgx in IOC_REGEX.items():
            for m in rgx.findall(s):
                if m not in iocs[k]:
                    iocs[k].append(m)
    return iocs


def simulate_behavior(strings: List[str]) -> List[str]:
    hints = []
    bad_words = ['CreateRemoteThread', 'GetProcAddress', 'VirtualAlloc', 'WinExec', 'cmd.exe', 'powershell']
    for w in bad_words:
        if any(w in s for s in strings):
            hints.append(f'Uses suspicious API: {w}')
    if any('http' in s for s in strings):
        hints.append('Network activity indicators present')
    if any('HKLM' in s or 'Registry' in s for s in strings):
        hints.append('Possible registry modification')
    return hints

