import os
from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton, QTextEdit, QFileDialog, QLineEdit, QProgressBar
)
from core.malware.sandbox import file_hashes, extract_strings, pe_metadata, extract_iocs, simulate_behavior, scan_yara
from core.utils.ai_client import summarize


class MalwareTab(QWidget):
    def __init__(self):
        super().__init__()
        self._init_ui()
        self.path = ''

    def _init_ui(self):
        root = QVBoxLayout(self)
        header = QLabel('Malware Analysis Sandbox (Static)')
        header.setStyleSheet('font-size:18px; font-weight:bold; color:#9bd1ff')
        root.addWidget(header)

        top = QHBoxLayout()
        open_btn = QPushButton('Open File')
        analyze_btn = QPushButton('Analyze')
        top.addWidget(open_btn)
        top.addWidget(analyze_btn)
        root.addLayout(top)

        yrow = QHBoxLayout()
        self.yara_dir = QLineEdit(); self.yara_dir.setPlaceholderText('YARA rules directory (optional)')
        pick_rules = QPushButton('Select Rules Dir')
        run_yara = QPushButton('Run YARA')
        yrow.addWidget(self.yara_dir)
        yrow.addWidget(pick_rules)
        yrow.addWidget(run_yara)
        root.addLayout(yrow)

        self.output = QTextEdit(); self.output.setReadOnly(True)
        root.addWidget(self.output)

        self.log_view = QTextEdit(); self.log_view.setReadOnly(True)
        root.addWidget(self.log_view)

        self.loader = QProgressBar(); self.loader.setRange(0,0); self.loader.hide()
        root.addWidget(self.loader)

        open_btn.clicked.connect(self.open_file)
        analyze_btn.clicked.connect(self.analyze)
        pick_rules.clicked.connect(self.select_rules)
        run_yara.clicked.connect(self.run_yara)

    def open_file(self):
        path, _ = QFileDialog.getOpenFileName(self, 'Open Binary', os.path.expanduser('~'), 'All (*)')
        if path:
            self.path = path
            self.output.append(f'File: {path}')

    def analyze(self):
        if not self.path:
            self.output.append('Open a file first.')
            return
        self.loader.show()
        hashes = file_hashes(self.path)
        self.output.append('Hashes: ' + str(hashes))
        strings = extract_strings(self.path)
        self.output.append(f'Extracted {len(strings)} strings')
        meta = pe_metadata(self.path)
        if meta:
            self.output.append('PE Metadata: ' + str(meta))
        iocs = extract_iocs(strings)
        self.output.append('IoCs: ' + str(iocs))
        hints = simulate_behavior(strings)
        self.output.append('Behavior hints: ' + '\n'.join(hints))
        sev = 'info'; tech = ''
        if strings and any('cmd.exe' in s.lower() or 'powershell' in s.lower() for s in strings[:5000]):
            sev = 'warning'; tech = 'T1059'
        if meta and any((meta.get('imports') or [])):
            imps = ','.join(meta.get('imports') or [])
            if 'WinInet' in imps or 'HttpSendRequest' in imps:
                tech = 'T1071'
        color = {'info':'#9bd1ff','warning':'#e0a800','danger':'#ff4d4d'}[sev]
        msg = f"[{sev.upper()}] Analyzed {os.path.basename(self.path)}"
        if tech:
            msg += f" MITRE:{tech}"
        self.log_view.append(f"<span style='color:{color}'>" + msg + "</span>")
        text = f"Hashes: {hashes}\nIoCs: {iocs}\nHints: {hints}"
        ai = summarize('Malware Analysis', text)
        if ai:
            self.output.append('\nAI Summary:\n' + ai)
        else:
            self.output.append('AI Summary unavailable.')
        self.loader.hide()

    def select_rules(self):
        d = QFileDialog.getExistingDirectory(self, 'Select YARA Rules Directory', os.path.expanduser('~'))
        if d:
            self.yara_dir.setText(d)

    def run_yara(self):
        if not self.path:
            self.output.append('Open a file first.')
            return
        d = self.yara_dir.text().strip()
        if not d:
            self.output.append('Select a YARA rules directory.')
            return
        self.loader.show()
        matches = scan_yara(self.path, d)
        if not matches:
            self.output.append('YARA: no matches or rules failed to load')
            self.loader.hide(); return
        self.output.append('YARA matches: ' + str(matches))
        self.log_view.append("<span style='color:#ff4d4d'>[DANGER] YARA matched â€” potential malware (MITRE:T1204)</span>")
        self.loader.hide()
