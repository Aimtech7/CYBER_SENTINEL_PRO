import os
from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel, QPushButton, QTextEdit, QFileDialog
)
from core.malware.sandbox import file_hashes, extract_strings, pe_metadata, extract_iocs, simulate_behavior
from core.utils.ai_client import summarize


class MalwareTab(QWidget):
    def __init__(self):
        super().__init__()
        self._init_ui()
        self.path = ''

    def _init_ui(self):
        root = QVBoxLayout(self)
        header = QLabel('Malware Analysis Sandbox (Static)')
        header.setStyleSheet('font-size:18px; font-weight:bold; color:#9bd1ff')
        root.addWidget(header)

        top = QHBoxLayout()
        open_btn = QPushButton('Open File')
        analyze_btn = QPushButton('Analyze')
        top.addWidget(open_btn)
        top.addWidget(analyze_btn)
        root.addLayout(top)

        self.output = QTextEdit(); self.output.setReadOnly(True)
        root.addWidget(self.output)

        open_btn.clicked.connect(self.open_file)
        analyze_btn.clicked.connect(self.analyze)

    def open_file(self):
        path, _ = QFileDialog.getOpenFileName(self, 'Open Binary', os.path.expanduser('~'), 'All (*)')
        if path:
            self.path = path
            self.output.append(f'File: {path}')

    def analyze(self):
        if not self.path:
            self.output.append('Open a file first.')
            return
        hashes = file_hashes(self.path)
        self.output.append('Hashes: ' + str(hashes))
        strings = extract_strings(self.path)
        self.output.append(f'Extracted {len(strings)} strings')
        meta = pe_metadata(self.path)
        if meta:
            self.output.append('PE Metadata: ' + str(meta))
        iocs = extract_iocs(strings)
        self.output.append('IoCs: ' + str(iocs))
        hints = simulate_behavior(strings)
        self.output.append('Behavior hints: ' + '\n'.join(hints))
        text = f"Hashes: {hashes}\nIoCs: {iocs}\nHints: {hints}"
        ai = summarize('Malware Analysis', text)
        if ai:
            self.output.append('\nAI Summary:\n' + ai)
        else:
            self.output.append('AI Summary unavailable.')

